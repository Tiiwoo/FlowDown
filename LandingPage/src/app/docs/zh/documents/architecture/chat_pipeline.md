# 聊天流程

当你点击 **发送** 按钮时，浮望会协调系统提示、附件、工具调用与模型推理，完成一次完整的对话交互。了解这个流程有助于你调试提示词、优化设置，并找到性能瓶颈。

## 1. 构建与校验

1. **合并上下文**：将你的草稿与历史记录合并。这包括已有的系统提示、过往的用户/助手消息，以及已添加到库中的附件，它们都会被转换为本次请求的一部分。
2. **能力检查**：检查当前模型是否具备所需能力（如视觉识别、工具调用、辅助任务）。如果缺失，系统会提示你切换模型或调整设置。
3. **注入动态指令**：按需添加系统指令：
   - 运行时信息（如模型名称、当前时间、语言环境）。
   - 启用浏览时的搜索模式提示（根据灵敏度预设）。
   - 长期记忆摘要与记忆工具的使用指南（当工具启用时）。
4. **追加用户输入**：在最新的系统指令之后追加当前的用户输入，确保模型能准确读取你的最终意图。

## 2. 预处理任务

在与模型正式对话前，浮望会执行一系列轻量级任务来准备上下文：

- **附件提取**：解析 PDF、图像和文本文件并生成摘要。对于缺少描述的图片，系统会进行本地识别（除非所选视觉模型允许跳过辅助识别）。
- **模板与记忆回调**：如果启用，系统会注入长期记忆摘要与记忆工具指引；已有的系统提示（包含模板）会从历史上下文中继承。
- **网络搜索规划**：当开启“浏览”且关闭“工具调用”时，浮望会根据最近的对话与附件文本，向模型请求最多 3 条短查询。模型可以判定无需搜索，也可以自动抓取结果并以 `<web_document id="n">` 的形式附加，方便引用。
- **工具环境准备**：汇总已启用的工具。在浏览关闭时，会过滤掉搜索工具；若启用了 MCP 服务器，会预热连接。

**注意**：上述步骤均在本地执行；只有在开启浏览/搜索或后续执行工具时，才会进行联网操作。

## 3. 推理循环执行

准备就绪后，浮望与所选模型进入交互循环：

1. **数据持久化**：保存用户消息与附件（开启“临时会话”时跳过入库）。在需要时，系统会补全图片描述并记录网页抓取占位。
2. **上下文裁剪**：估算完整请求（含工具定义）的 Token 占用量。如果超出上限，系统会优先删除最早的非系统消息，并提示你发生了裁剪。
3. **发送提示**：将准备好的消息与工具定义以流式传输的方式发送给模型。
4. **监控输出**：展示模型的思考过程，收集工具调用请求，并接收模型生成的图片（作为用户附件入库并附带描述）。
5. **处理工具调用**：验证并执行工具（确认规则仍生效）。网络搜索工具会直接注入抓取到的文档；其他工具可返回图片/音频（音频会转码），超长文本会在 64k 处截断后回填给模型。
6. **继续迭代**：模型收到工具结果后，可继续推理或再次触发工具，直到没有待处理的调用为止。

你可以随时使用停止按钮终止流程；在输入框长按唤出的快捷菜单中，也能临时禁用工具。

## 4. 回复整合

- 将最终文本、代码块、内联图片与工具输出组合进渲染器（网页搜索引用会按编号保留）。
- 进行格式优化（如 Markdown 渲染、代码美化、LaTeX 高亮），并修正网页结果的链接引用。
- 根据你的偏好折叠或展开推理区块（可在 **设置 → 对话界面** 中调整）。

## 5. 持久化与同步

- 消息、附件（含自动生成的图片描述、网页文档、工具生成的媒体文件）与工具结果将写入本地数据库。
- 如果开启了 iCloud，同步任务会进入 CloudKit 队列；否则仅保存在本地。
- 更新撤销/重做栈，确保你可以返回草稿状态或撤销操作。

## 6. 辅助任务

- 若开启了自动重命名，系统会调用辅助模型刷新对话标题与图标。
- 记录诊断日志，方便你在 **设置 → 支持** 中导出排查问题。
- 向 Shortcuts、MCP、日历等自动化流程广播完成信号。

你可以全程查看这些细节：在消息菜单选择 **原始数据** 可查看发送给模型的完整提示；工具调用记录也会显示在推理区块中。
