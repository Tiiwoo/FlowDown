# MCP 工具集成

MCP（Model Context Protocol）允许浮望与外部助手、文件系统或 API 建立扩展连接。它沿用浮望的工具调用流程，确认机制、日志记录以及“跳过工具确认”开关同样适用。

::: warning 注意
请务必仅连接受信任的 MCP 服务器——它们可能接收完整的对话内容与附件元数据。
:::

## 添加与配置服务器

1. 打开 **设置 → 工具 → MCP 服务器**，点击 **+ → 创建服务器**（仅支持 HTTP/HTTPS）。
2. 填写 **Endpoint**（通常以 `/mcp/` 结尾）与可选的 **Headers**（JSON 映射，随每次请求发送，用于鉴权或租户标识）。可设置 **别名** 便于显示，未设置则使用主机名。传输方式固定为 **Streamable HTTP**。
3. 打开 **启用** 开关，让浮望自动重连并同步工具。关闭开关可暂停而不删除服务器。
4. 点击 **连通性验证** 发起握手并列出可用工具。验证后列表中的状态会更新为 **已连接/连接中/已断开**。

![服务器配置界面](../../../res/screenshots/imgs/flowdown-mcp-server-configuration.png)

## 导入与导出

- 在服务器详情页（**管理 → 导出服务器**）或列表长按菜单中导出 `.fdmcp` 文件，以便分享或备份。
- 通过 **+ → 从文件导入**、将 `.fdmcp` 文件拖入列表，或在浮望中打开 `.fdmcp` 文件/URL（如来自“文件”应用或 AirDrop）即可完成导入。

## 对话交互

- 启用的服务器会在对话准备阶段自动重连，若模型支持工具调用，其工具会加入工具列表。
- 当模型请求 MCP 工具集成时，浮望会弹出确认提示，展示服务器和工具名称及描述。全局 **跳过工具确认** 开关（设置 → 工具）同样适用。
- 批准后执行，结果写入推理面板：文本直接展示，图片/音频输出会作为附件供你与模型查看，错误会记录日志。
- 设置页面中的状态徽标会实时反映连接情况。若卡住，可重新运行 **连通性验证**。

![工具集成与 MCP 服务器列表](../../../res/screenshots/imgs/ai-assistant-tool-integration-and-mcp-configuration.png)

### 示例场景

- “列出当前目录文件” → 文件系统 MCP。
- “总结最新的 Pull Request” → GitHub MCP。
- “发送一封邮件给团队” → 邮件 MCP。

## 支持的传输协议

- 仅支持 **HTTP/HTTPS** 流式传输。

关于其他两种常见协议的说明：

- App Store 要求软件开启沙盒，因此无法支持 stdio。
- SSE 传输协议被标记为弃用，因此不予支持。

## 最佳实践

- 启用前审阅隐私范围与凭据，必要时轮换密钥。
- 不使用时关闭服务器，避免后台重连。
- 可在 **设置 → 支持 → 日志** 中审计工具调用，只保留当前对话真正需要的服务器。

## 进阶：手动配置 `.fdmcp`

你可以导出 `.fdmcp` 文件，修改额外的字段来启用高级功能。

- `name`：自定义别名。为空则回退到主机名。
- `timeout`：请求超时秒数（整数）。

修改后通过 **MCP 服务器 → + → 从文件导入** 或直接在浮望中打开文件，再运行 **连通性验证** 检查配置。
