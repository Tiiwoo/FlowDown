# 网络搜索

浮望提供两种网络搜索模式：

1. **预处理模式**：当模型不支持工具调用时使用。
2. **工具调用模式**：当模型支持工具调用时，由助手直接调用 `web_search`。

**建议**：若模型具备工具能力，建议同时开启“网页浏览”和“工具”，让模型自行规划关键词与引用。

## 启用搜索

- 前往 **设置 → 工具 → 网络浏览** 或在会话输入框上方开启 **网页浏览**。
- **模型支持工具调用时**：同时打开 **网页浏览** 与 **工具**。浮望将跳过预处理，由模型发起 `web_search`。
- **模型不支持工具调用时**：关闭 **工具**，仅开启 **网页浏览**。浮望会请辅助模型判断是否搜索并生成查询。

## 配置指南

- **搜索策略 (Search Strategy)**：
  - **Essential（必要）**：仅在必要时搜索。
  - **Balanced（平衡）**：平衡搜索频率与回答速度。
  - **Proactive（主动）**：积极搜索以获取更多信息。

![网络搜索策略与引擎配置](../../../res/screenshots/imgs/web-search-strategy-and-engine-configuration.png)

- **搜索上限 (Search Limit)**：限制抓取页数（5/10/15/20/无限页）。同一轮多条查询共享此上限，超出上下文限制的页面将被自动忽略，以防 Token 溢出。

![网络搜索参数配置界面](../../../res/screenshots/imgs/web-search-parameter-configuration-interface.png)

- **网页搜索引擎**：可切换 Google / DuckDuckGo / Yahoo / Bing，至少保持一个开启。若全部关闭，系统会自动回退到 Google。

## 执行流程

### 预处理模式（不使用工具调用）

1. **收集上下文**：获取最近 5 条用户/助手消息及附件文本。
1. **规划查询**：辅助模型按搜索策略生成 XML，包含 `search_required` 与最多 3 条查询（2–25 字，使用用户语言）。若判定无需搜索，会写入提示。
1. **失败处理**：若没有生成查询，浮望会提示无法生成关键词并跳过联网。
1. **抓取**：每条查询由 ScrubberKit + URLsReranker 执行（每主机保留 4 条），并按上限分配，实时显示来源/站点/结果数量。
1. **注入附件**：结果随机化后写入带编号的 `web_document` 附件供模型引用。若无结果，将报错 “No web search results.”。

### 工具调用模式

- 模型调用 `web_search` 时，浮望复用同一抓取流水线并在状态面板流式展示进度。
- 工具返回包含 `web_document` 文本。若无结果则返回 “Web search returned no results.”。

## 适用场景

- 追踪快速变化的新闻或公告。
- 查询最新的价格、供应或政策信息。
- 检索专业领域的最新文章或文档。
- 从公开网页中提取结构化数据。

## 最佳实践

### 提问技巧

- **提供上下文**：例如“查一下 FlowDown 最新版本的评价”。
- **指定范围**：例如“寻找 2025 年 10 月之后更新的文档”。
- **结合附件**：可与附件或本地笔记结合使用。让助手用 `[^编号]` 标注 `web_document`。

### 搜索调优

- **动态话题**：选择 **均衡** 或 **主动**。
- **追求速度**：选择 **必要**。
- **引擎选择**：至少启用一个引擎。更多引擎可提升召回率但会增加时延。
- **上限调整**：长文或稀疏结果时提高搜索上限；节省流量时调低。
- **结果确认**：在推理面板确认网址与摘要后再参考回复。

## 隐私说明

- 浮望仅发送必要的搜索词，不附加个人标识。
- 抓取结果保存在本地会话，仅在你开启 iCloud 同步时才上传 iCloud。
- 若合规要求禁止访问外部搜索服务，可在工具设置中关闭该功能。

## 实现细节

- 查询生成由辅助模型完成，受搜索策略提示控制（`Model.Inference.SearchSensitivity`）。
- 抓取依赖 [ScrubberKit](https://github.com/Lakr233/ScrubberKit) 与 URLsReranker，并受引擎开关与搜索上限（`ScrubberConfiguration`）约束。
- 工具入口为 `MTWebSearchTool`，对话层负责状态更新并用 `formatAsWebArchive` 生成可引用的 `web_document`。
