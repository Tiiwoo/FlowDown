name: Test

# This workflow runs unit tests on pull requests.
# To make this workflow a required check before merging PRs:
# 1. Go to repository Settings â†’ Branches
# 2. Add or edit branch protection rule for your main branch
# 3. Enable "Require status checks to pass before merging"
# 4. Search for and select "Unit Tests" in the status checks list
# 5. Save the protection rule

on:
  pull_request:
    paths:
      - "FlowDown/**"
      - "Frameworks/**"
      - "FlowDownUnitTests/**"
      - "Resources/**"
      - "FlowDown.xcodeproj/**"
      - "FlowDown.xcworkspace/**"
      - ".github/workflows/test.yml"
      - "Makefile"
      - "Package.resolved"

jobs:
  test:
    if: ${{ !startsWith(github.head_ref, 'housekeeping/') }}
    name: Unit Tests
    runs-on: macos-26
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Select Newest Xcode
        run: |
          chmod +x Resources/DevKit/scripts/select_newest_xcode.sh
          ./Resources/DevKit/scripts/select_newest_xcode.sh

      - name: Resolve Packages
        run: |
          set -o pipefail
          xcodebuild -downloadComponent MetalToolchain
          xcodebuild \
            -workspace FlowDown.xcworkspace \
            -scheme FlowDown \
            -resolvePackageDependencies \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcbeautify --is-ci --disable-colored-output --disable-logging

      - name: Disable CloudKit for CI Testing
        run: |
          echo '' >> FlowDown/Configuration/DevelopmentDeveloper.xcconfig
          echo 'SWIFT_ACTIVE_COMPILATION_CONDITIONS = $(inherited) TEST_SIMULATOR_DISABLE_CLOUD_KIT' >> FlowDown/Configuration/DevelopmentDeveloper.xcconfig
          echo 'generated ci configuration for testing'
          cat FlowDown/Configuration/DevelopmentDeveloper.xcconfig

      - name: Build FlowDown (for codegen)
        run: |
          set -o pipefail
          xcodebuild -downloadComponent MetalToolchain
          DESTINATION=$(bash Resources/DevKit/scripts/get_first_ios_simulator.sh)
          xcodebuild \
            -workspace FlowDown.xcworkspace \
            -scheme FlowDown \
            -configuration Debug \
            -destination "$DESTINATION" \
            build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcbeautify --is-ci --disable-colored-output --disable-logging

      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild -downloadComponent MetalToolchain
          DESTINATION=$(bash Resources/DevKit/scripts/get_first_ios_simulator.sh)
          xcodebuild \
            -workspace FlowDown.xcworkspace \
            -scheme FlowDownUnitTests \
            -configuration Debug \
            -destination "$DESTINATION" \
            test \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcbeautify --is-ci --disable-colored-output --disable-logging

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult
          if-no-files-found: warn
          retention-days: 7
